blueprint:
  name: Smart Alexa Echo Volume Control
  description: >
    Automatically adjusts volume levels of Alexa Echo devices based on mode changes (night mode, presence detection, etc.).
    Works with Home Assistant's Alexa Media Player integration to control Echo volume entities.
    Improved version with proper filtering for Alexa Media Player devices.
  domain: automation
  input:
    mode_entity:
      name: Mode Control Entity
      description: Entity that triggers volume changes (e.g., night mode helper, presence sensor)
      selector:
        entity:
          domain: 
            - input_boolean
            - binary_sensor
            - sensor
            - switch
    
    echo_entities:
      name: Echo Volume Entities
      description: Select specific Echo volume entities to control (leave empty for auto-discovery)
      selector:
        entity:
          domain: media_player
          integration: alexa_media
          multiple: true
      default: []
    
    low_volume:
      name: Low Volume Level
      description: Volume level when mode is active (0-100)
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
      default: 20
    
    high_volume:
      name: High Volume Level  
      description: Volume level when mode is inactive (0-100)
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
      default: 40
    
    ignore_entities:
      name: Ignored Echo Devices
      description: Echo entities to exclude from automatic control
      selector:
        entity:
          domain: media_player
          integration: alexa_media
          multiple: true
      default: []
    
    ignore_patterns:
      name: Ignore Device Name Patterns
      description: Device name patterns to ignore (one per line, e.g., "basement", "garage", "bedroom")
      selector:
        text:
          multiline: true
      default: ""
    
    special_device:
      name: Special Echo Device (Optional)
      description: Echo entity that gets different volume levels than the others
      selector:
        entity:
          domain: media_player
          integration: alexa_media
          multiple: false
      default: ""
    
    special_low_volume:
      name: Special Device Low Volume
      description: Special Echo device volume when mode is active (0-100)
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
      default: 30
    
    special_high_volume:
      name: Special Device High Volume
      description: Special Echo device volume when mode is inactive (0-100)
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"
          mode: slider
      default: 80
    
    use_random_delay:
      name: Use Random Delays
      description: Add random delays to prevent simultaneous commands (recommended for many devices)
      selector:
        boolean: {}
      default: true
    
    max_delay:
      name: Maximum Random Delay
      description: Maximum delay in seconds for randomization
      selector:
        number:
          min: 1
          max: 30
          step: 1
          unit_of_measurement: "seconds"
          mode: slider
      default: 10
    
    special_delay:
      name: Special Device Delay
      description: Fixed delay for special device in seconds
      selector:
        number:
          min: 0
          max: 60
          step: 1
          unit_of_measurement: "seconds"
          mode: slider
      default: 15

  source_url: https://github.com/your-repo/HomeAssistant/blob/main/SmartVolumeControl/SmartVolumeControl.yaml

variables:
  mode_entity: !input mode_entity
  echo_entities: !input echo_entities
  low_volume: !input low_volume
  high_volume: !input high_volume
  ignore_entities: !input ignore_entities
  ignore_patterns: !input ignore_patterns
  special_device: !input special_device
  special_low_volume: !input special_low_volume
  special_high_volume: !input special_high_volume
  use_random_delay: !input use_random_delay
  max_delay: !input max_delay
  special_delay: !input special_delay

trigger:
  - platform: state
    entity_id: !input mode_entity
    id: "mode_change"

condition:
  # Only trigger when the entity actually changes state (not just attributes)
  - condition: template
    value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"

action:
  - variables:
      # Determine if mode is active (various entity types)
      mode_active: >
        {% if mode_entity.startswith('input_boolean.') or mode_entity.startswith('switch.') %}
          {{ is_state(mode_entity, 'on') }}
        {% elif mode_entity.startswith('binary_sensor.') %}
          {{ is_state(mode_entity, 'on') }}
        {% else %}
          {{ states(mode_entity) in ['on', 'true', 'active', 'home'] }}
        {% endif %}
      
      # Get target volume based on mode
      target_volume: >
        {{ special_low_volume if mode_active else special_high_volume }}
      
      normal_volume: >
        {{ low_volume if mode_active else high_volume }}
      
      # Get patterns to ignore
      ignore_pattern_list: >
        {% if ignore_patterns.strip() != '' %}
          {{ ignore_patterns.strip().split('\n') }}
        {% else %}
          []
        {% endif %}
      
      # Get list of Echo media_player entities to control
      all_echo_entities: >
        {% if echo_entities | length > 0 %}
          {{ echo_entities }}
        {% else %}
          {% set all_entities = [] %}
          
          {# Find Alexa Media Player entities #}
          {% for entity in states.media_player %}
            {% if state_attr(entity.entity_id, 'integration') == 'alexa_media' %}
              {% set all_entities = all_entities + [entity.entity_id] %}
            {% endif %}
          {% endfor %}
          
          {{ all_entities }}
        {% endif %}
      
      # Filter out ignored entities and patterns
      filtered_entities: >
        {% set entities = all_echo_entities %}
        {% set ignored_entities = ignore_entities %}
        {% set ignored_patterns = ignore_pattern_list %}
        {% set result = [] %}
        
        {% for entity in entities %}
          {% set skip_entity = false %}
          
          {# Check ignore list #}
          {% if entity in ignored_entities %}
            {% set skip_entity = true %}
          {% endif %}
          
          {# Check ignore patterns #}
          {% for pattern in ignored_patterns %}
            {% if pattern.strip() != '' and pattern.strip().lower() in entity.lower() %}
              {% set skip_entity = true %}
            {% endif %}
          {% endfor %}
          
          {% if not skip_entity %}
            {% set result = result + [entity] %}
          {% endif %}
        {% endfor %}
        
        {{ result }}

  # Control normal Echo volume entities
  - repeat:
      for_each: "{{ filtered_entities }}"
      sequence:
        - condition: template
          value_template: "{{ repeat.item != special_device }}"
        
        - variables:
            random_delay: >
              {% if use_random_delay %}
                {{ range(1, max_delay * 1000) | random / 1000 }}
              {% else %}
                0
              {% endif %}
        
        - delay:
            seconds: "{{ random_delay }}"
        
        # Set volume for Alexa Media Player
        - service: media_player.volume_set
          target:
            entity_id: "{{ repeat.item }}"
          data:
            volume_level: "{{ normal_volume / 100 }}"
          continue_on_error: true

  # Control special Echo device if specified
  - condition: template
    value_template: "{{ special_device != '' }}"
  
  - delay:
      seconds: "{{ special_delay }}"
  
  # Set volume for special device
  - service: media_player.volume_set
    target:
      entity_id: "{{ special_device }}"
    data:
      volume_level: "{{ target_volume / 100 }}"
    continue_on_error: true

mode: single 